# Docker Compose íŒŒì¼ í¬ë§·ì˜ ë²„ì „ì„ ì§€ì •í•©ë‹ˆë‹¤.
version: '3.8'
services:
  config-service:
    image: hjyun291/config-service:1.0
    container_name: config-service
    networks:
      - msa-network
    ports:
      - "8888:8888"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://config-service:8888/actuator/health"]
      interval: 15s #15ì´ˆë§ˆë‹¤ í•œë²ˆì”© ì²´í¬
      timeout: 5s # 5ì´ˆ ì•ˆì— ì™„ë£Œë˜ì–´ì•¼ í•œë‹¤.
      retries: 3 # 3ë²ˆê¹Œì§€ ì¬ì‹œë„ í•˜ê¸°
      start_period: 30s # ì»¨í…Œì´ë„ˆ ì‹œì‘ í›„ 60ì´ˆ ë™ì•ˆì€ ì ê¹ ëŒ€ê¸° (health checkë¥¼ ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
    restart: always # ì»¨í…Œì´ë„ˆê°€ ëª¨ì¢…ì˜ ì´ìœ ë¡œ ì¤‘ì§€ë˜ë©´ ë¬´ì¡°ê±´ ì¬ì‹œì‘ ì‹œë„.


  discovery-service:
    image: hjyun291/discovery-service:1.0
    container_name: discovery-service
    networks:
      - msa-network
    ports:
      - "8761:8761"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://discovery-service:8761" ]
      interval: 15s #15ì´ˆë§ˆë‹¤ í•œë²ˆì”© ì²´í¬
      timeout: 5s # 5ì´ˆ ì•ˆì— ì™„ë£Œë˜ì–´ì•¼ í•œë‹¤.
      retries: 3 # 3ë²ˆê¹Œì§€ ì¬ì‹œë„ í•˜ê¸°
      start_period: 30s # ì»¨í…Œì´ë„ˆ ì‹œì‘ í›„ 60ì´ˆ ë™ì•ˆì€ ì ê¹ ëŒ€ê¸° (health checkë¥¼ ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
    restart: always # ì»¨í…Œì´ë„ˆê°€ ëª¨ì¢…ì˜ ì´ìœ ë¡œ ì¤‘ì§€ë˜ë©´ ë¬´ì¡°ê±´ ì¬ì‹œì‘ ì‹œë„.

  gateway-service:
    image: hjyun291/gateway-service:1.0
    container_name: gateway-service
    networks:
      - msa-network
    ports:
      - "8000:8000"
    depends_on:
      # gatewayëŠ” discoveryì™€ configê°€ ê±´ê°•í•´ì•¼ì§€ë§Œ ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë©ë‹ˆë‹¤.
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    restart: always

  user-service:
    image: hjyun291/user-service:1.0
    container_name: user-service
    networks:
      - msa-network
    depends_on:
      # gatewayëŠ” discoveryì™€ configê°€ ê±´ê°•í•´ì•¼ì§€ë§Œ ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë©ë‹ˆë‹¤.
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    restart: always

  order-service:
    image: hjyun291/order-service:1.0
    container_name: order-service
    networks:
      - msa-network
    depends_on:
      # gatewayëŠ” discoveryì™€ configê°€ ê±´ê°•í•´ì•¼ì§€ë§Œ ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë©ë‹ˆë‹¤.
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    restart: always

  product-service:
    image: hjyun291/product-service:1.0
    container_name: product-service
    networks:
      - msa-network
    depends_on:
      # gatewayëŠ” discoveryì™€ configê°€ ê±´ê°•í•´ì•¼ì§€ë§Œ ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë©ë‹ˆë‹¤.
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    restart: always

  redis:
    image: redis:latest
    ports:
      - "6379:6379"
    networks:
      - msa-network
  mysql-db: # ë‘ë²ˆì§¸ ì„œë¹„ìŠ¤ ì´ë¦„ì€ dbì•¼.
    image: mysql:8 # ë¹Œë“œí•˜ì§€ ì•Šê³  ë¯¸ë¦¬ ì¤€ë¹„ëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ê² ë‹¤.
    ports:
      - "3316:3306"
    environment: # mysql ì»¨í…Œì´ë„ˆì— ì ìš©í•  í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      MYSQL_ROOT_PASSWORD: mysql
      MYSQL_DATABASE: orderservice
    volumes: # ë³¼ë¥¨: ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•˜ëŠ” ë°ì´í„° ì €ì¥ì†Œ, ì»¨í…Œì´ë„ˆê°€ ì‚­ì œë˜ê±°ë‚˜ ì¬ì‹œì‘í•˜ë”ë¼ë„ ë°ì´í„°ê°€ ë³´ì¡´.
      - db-data:/var/lib/mysql

# ì„œë¹„ìŠ¤ë“¤ì´ ì—°ê²°ë  Docker ë„¤íŠ¸ì›Œí¬ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ë™ì¼í•œ í˜¸ìŠ¤íŠ¸ ë‚´ì—ì„œ ì„œë¡œ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” Dockerì˜ ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„.
networks:
  msa-network:
    driver: bridge

volumes:         # ğŸ‘ˆ ì´ ë¶€ë¶„ ì¶”ê°€!
  db-data: